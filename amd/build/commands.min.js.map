{"version":3,"file":"commands.min.js","sources":["../src/commands.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny persistentresize commands\n *\n * @module     tiny_persistentresize/commands\n * @copyright  2025 Andrew Rowatt <A.J.Rowatt@massey.ac.nz>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {getButtonImage} from 'editor_tiny/utils';\nimport {get_string as getString} from 'core/str';\nimport {component, buttonName, clearAllButtonName, icon, iconclearall} from 'tiny_persistentresize/common';\nimport Notification from 'core/notification';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport {getUsername} from 'tiny_persistentresize/options';\nimport * as Storage from 'tiny_persistentresize/storage';\n\nexport const getSetup = async() => {\n    const [\n        menuTitle,\n        menuImage,\n        menuClearAllImage,\n        confirmationTitle,\n        confirmationMessage,\n        clearAllMenuTitle,\n        clearAllConfirmTitle,\n        clearAllConfirmMessage,\n        clearAllSuccessTitle,\n        clearAllSuccessMessage,\n        yesString,\n    ] = await Promise.all([\n        getString('menutitle', component),\n        getButtonImage('menuicon', component),\n        getButtonImage('menuclearallicon', component),\n        getString('confirmationtitle', component),\n        getString('confirmationmessage', component),\n        getString('clearallmenutitle', component),\n        getString('clearallconfirmtitle', component),\n        getString('clearallconfirmmessage', component),\n        getString('clearallsuccesstitle', component),\n        getString('clearallsuccessmessage', component),\n        getString('yes', 'core'),\n    ]);\n\n    return (editor) => {\n        // Register the persistentresize icon.\n        editor.ui.registry.addIcon(icon, menuImage.html);\n        editor.ui.registry.addIcon(iconclearall, menuClearAllImage.html);\n\n        // Register the Menu item.\n        editor.ui.registry.addMenuItem(buttonName, {\n            icon,\n            text: menuTitle,\n            onAction: async() => {\n                const target = editor.getElement();\n                const username = getUsername(editor);\n                const defaultKey = `${username}_tiny_persistentresize_height_${target.id}_default`;\n                const heightKey = `${username}_tiny_persistentresize_height_${target.id}`;\n\n                try {\n                    const storedDefaultheight = await Storage.getItem(defaultKey);\n\n                    // Reset to default height and remove stored height preference.\n                    // Tiny will handle the actual resize and a null height with a sensible default.\n                    editor.editorContainer.style.height = storedDefaultheight;\n                    await Storage.removeItem(heightKey);\n                    await Storage.removeItem(defaultKey);\n                    // Notify the user.\n                    Notification.alert(confirmationTitle, confirmationMessage);\n                } catch (error) {\n                    Notification.exception(error);\n                }\n            },\n        });\n\n        // Register the \"Clear All\" Menu item.\n        editor.ui.registry.addMenuItem(clearAllButtonName, {\n            icon: iconclearall,\n            text: clearAllMenuTitle,\n            onAction: () => {\n                // Show confirmation dialog.\n                ModalFactory.create({\n                    type: ModalFactory.types.SAVE_CANCEL,\n                    title: clearAllConfirmTitle,\n                    body: clearAllConfirmMessage,\n                }).then((modal) => {\n                    modal.setSaveButtonText(yesString);\n                    modal.getRoot().on(ModalEvents.save, async() => {\n                        try {\n                            // Save the current editor's default height before clearing.\n                            const target = editor.getElement();\n                            const username = getUsername(editor);\n                            const defaultKey = `${username}_tiny_persistentresize_height_${target.id}_default`;\n                            const storedDefaultheight = await Storage.getItem(defaultKey);\n\n                            // Clear all IndexedDB items related to this plugin for this user.\n                            const allKeys = await Storage.getAllKeys();\n                            const prefix = `${username}_tiny_persistentresize_height_`;\n                            const keysToRemove = allKeys.filter(key => key.startsWith(prefix));\n                            await Promise.all(keysToRemove.map(key => Storage.removeItem(key)));\n\n                            // Reset the current editor to default height.\n                            if (storedDefaultheight) {\n                                editor.editorContainer.style.height = storedDefaultheight;\n                            }\n\n                            // Notify the user.\n                            Notification.alert(clearAllSuccessTitle, clearAllSuccessMessage);\n                        } catch (error) {\n                            Notification.exception(error);\n                        }\n                    });\n                    modal.show();\n                    return modal;\n                }).catch(Notification.exception);\n            },\n        });\n\n        // Restore the editor height from IndexedDB if it exists.\n        editor.on('init', async() => {\n            const target = editor.getElement();\n            const username = getUsername(editor);\n            const defaultKey = `${username}_tiny_persistentresize_height_${target.id}_default`;\n            const heightKey = `${username}_tiny_persistentresize_height_${target.id}`;\n\n            try {\n                // Store the default height in case the user wants to reset it later.\n                await Storage.setItem(defaultKey, editor.editorContainer.style.height);\n\n                const storedheight = await Storage.getItem(heightKey);\n                if (storedheight) {\n                    editor.editorContainer.style.height = storedheight;\n                }\n            } catch (error) {\n                Notification.exception(error);\n            }\n        });\n\n        // Store the editor height in IndexedDB whenever it is resized.\n        // Debounce to prevent excessive writes during rapid resize operations.\n        let resizeTimeout;\n        editor.on('ResizeEditor', async() => {\n            clearTimeout(resizeTimeout);\n            resizeTimeout = setTimeout(async() => {\n                const target = editor.getElement();\n                const username = getUsername(editor);\n                const heightKey = `${username}_tiny_persistentresize_height_${target.id}`;\n\n                try {\n                    await Storage.setItem(heightKey, editor.editorContainer.style.height);\n                } catch (error) {\n                    Notification.exception(error);\n                }\n            }, 300); // Wait 300ms after resize stops before saving\n        });\n    };\n};\n"],"names":["async","menuTitle","menuImage","menuClearAllImage","confirmationTitle","confirmationMessage","clearAllMenuTitle","clearAllConfirmTitle","clearAllConfirmMessage","clearAllSuccessTitle","clearAllSuccessMessage","yesString","Promise","all","component","editor","resizeTimeout","ui","registry","addIcon","icon","html","iconclearall","addMenuItem","buttonName","text","onAction","target","getElement","username","defaultKey","id","heightKey","storedDefaultheight","Storage","getItem","editorContainer","style","height","removeItem","alert","error","exception","clearAllButtonName","create","type","ModalFactory","types","SAVE_CANCEL","title","body","then","modal","setSaveButtonText","getRoot","on","ModalEvents","save","allKeys","getAllKeys","prefix","keysToRemove","filter","key","startsWith","map","show","catch","Notification","setItem","storedheight","clearTimeout","setTimeout"],"mappings":";;;;;;;o6BAgCwBA,gBAEhBC,UACAC,UACAC,kBACAC,kBACAC,oBACAC,kBACAC,qBACAC,uBACAC,qBACAC,uBACAC,iBACMC,QAAQC,IAAI,EAClB,mBAAU,YAAaC,oBACvB,yBAAe,WAAYA,oBAC3B,yBAAe,mBAAoBA,oBACnC,mBAAU,oBAAqBA,oBAC/B,mBAAU,sBAAuBA,oBACjC,mBAAU,oBAAqBA,oBAC/B,mBAAU,uBAAwBA,oBAClC,mBAAU,yBAA0BA,oBACpC,mBAAU,uBAAwBA,oBAClC,mBAAU,yBAA0BA,oBACpC,mBAAU,MAAO,iBAGbC,aAgGAC,cA9FJD,OAAOE,GAAGC,SAASC,QAAQC,aAAMlB,UAAUmB,MAC3CN,OAAOE,GAAGC,SAASC,QAAQG,qBAAcnB,kBAAkBkB,MAG3DN,OAAOE,GAAGC,SAASK,YAAYC,mBAAY,CACvCJ,KAAAA,aACAK,KAAMxB,UACNyB,SAAU1B,gBACA2B,OAASZ,OAAOa,aAChBC,UAAW,wBAAYd,QACvBe,qBAAgBD,kDAAyCF,OAAOI,eAChEC,oBAAeH,kDAAyCF,OAAOI,cAG3DE,0BAA4BC,QAAQC,QAAQL,YAIlDf,OAAOqB,gBAAgBC,MAAMC,OAASL,0BAChCC,QAAQK,WAAWP,iBACnBE,QAAQK,WAAWT,kCAEZU,MAAMpC,kBAAmBC,qBACxC,MAAOoC,6BACQC,UAAUD,WAMnC1B,OAAOE,GAAGC,SAASK,YAAYoB,2BAAoB,CAC/CvB,KAAME,qBACNG,KAAMnB,kBACNoB,SAAU,4BAEOkB,OAAO,CAChBC,KAAMC,uBAAaC,MAAMC,YACzBC,MAAO1C,qBACP2C,KAAM1C,yBACP2C,MAAMC,QACLA,MAAMC,kBAAkB1C,WACxByC,MAAME,UAAUC,GAAGC,sBAAYC,MAAMzD,oBAGvB2B,OAASZ,OAAOa,aAChBC,UAAW,wBAAYd,QACvBe,qBAAgBD,kDAAyCF,OAAOI,eAChEE,0BAA4BC,QAAQC,QAAQL,YAG5C4B,cAAgBxB,QAAQyB,aACxBC,iBAAY/B,2CACZgC,aAAeH,QAAQI,QAAOC,KAAOA,IAAIC,WAAWJ,gBACpDhD,QAAQC,IAAIgD,aAAaI,KAAIF,KAAO7B,QAAQK,WAAWwB,QAGzD9B,sBACAlB,OAAOqB,gBAAgBC,MAAMC,OAASL,2CAI7BO,MAAM/B,qBAAsBC,wBAC3C,MAAO+B,6BACQC,UAAUD,WAG/BW,MAAMc,OACCd,SACRe,MAAMC,sBAAa1B,cAK9B3B,OAAOwC,GAAG,QAAQvD,gBACR2B,OAASZ,OAAOa,aAChBC,UAAW,wBAAYd,QACvBe,qBAAgBD,kDAAyCF,OAAOI,eAChEC,oBAAeH,kDAAyCF,OAAOI,cAI3DG,QAAQmC,QAAQvC,WAAYf,OAAOqB,gBAAgBC,MAAMC,cAEzDgC,mBAAqBpC,QAAQC,QAAQH,WACvCsC,eACAvD,OAAOqB,gBAAgBC,MAAMC,OAASgC,cAE5C,MAAO7B,6BACQC,UAAUD,WAO/B1B,OAAOwC,GAAG,gBAAgBvD,UACtBuE,aAAavD,eACbA,cAAgBwD,YAAWxE,gBACjB2B,OAASZ,OAAOa,aAChBC,UAAW,wBAAYd,QACvBiB,oBAAeH,kDAAyCF,OAAOI,cAG3DG,QAAQmC,QAAQrC,UAAWjB,OAAOqB,gBAAgBC,MAAMC,QAChE,MAAOG,6BACQC,UAAUD,UAE5B"}