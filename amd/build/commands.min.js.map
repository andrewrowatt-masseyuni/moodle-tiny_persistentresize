{"version":3,"file":"commands.min.js","sources":["../src/commands.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny persistentresize commands\n *\n * @module     tiny_persistentresize/commands\n * @copyright  2025 Andrew Rowatt <A.J.Rowatt@massey.ac.nz>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {getButtonImage} from 'editor_tiny/utils';\nimport {get_string as getString} from 'core/str';\nimport {component, buttonName, clearAllButtonName, icon, iconclearall} from 'tiny_persistentresize/common';\nimport Notification from 'core/notification';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\n\nexport const getSetup = async() => {\n    const [\n        menuTitle,\n        menuImage,\n        menuClearAllImage,\n        confirmationTitle,\n        confirmationMessage,\n        clearAllMenuTitle,\n        clearAllConfirmTitle,\n        clearAllConfirmMessage,\n        clearAllSuccessTitle,\n        clearAllSuccessMessage,\n        yesString,\n    ] = await Promise.all([\n        getString('menutitle', component),\n        getButtonImage('menuicon', component),\n        getButtonImage('menuclearallicon', component),\n        getString('confirmationtitle', component),\n        getString('confirmationmessage', component),\n        getString('clearallmenutitle', component),\n        getString('clearallconfirmtitle', component),\n        getString('clearallconfirmmessage', component),\n        getString('clearallsuccesstitle', component),\n        getString('clearallsuccessmessage', component),\n        getString('yes', 'core'),\n    ]);\n\n    return (editor) => {\n        // Register the persistentresize icon.\n        editor.ui.registry.addIcon(icon, menuImage.html);\n        editor.ui.registry.addIcon(iconclearall, menuClearAllImage.html);\n\n        // Register the Menu item.\n        editor.ui.registry.addMenuItem(buttonName, {\n            icon,\n            text: menuTitle,\n            onAction: () => {\n                const target = editor.getElement();\n                const storedDefaultheight = localStorage.getItem(`tiny_persistentresize_height_${target.id}_default`);\n\n                // Reset to default height and remove stored height preference.\n                // Tiny will handle the actual resize and a null height with a sensible default.\n                editor.editorContainer.style.height = storedDefaultheight;\n                localStorage.removeItem(`tiny_persistentresize_height_${target.id}`);\n                localStorage.removeItem(`tiny_persistentresize_height_${target.id}_default`);\n                // Notify the user.\n                Notification.alert(confirmationTitle, confirmationMessage);\n            },\n        });\n\n        // Register the \"Clear All\" Menu item.\n        editor.ui.registry.addMenuItem(clearAllButtonName, {\n            icon: iconclearall,\n            text: clearAllMenuTitle,\n            onAction: () => {\n                // Show confirmation dialog.\n                ModalFactory.create({\n                    type: ModalFactory.types.SAVE_CANCEL,\n                    title: clearAllConfirmTitle,\n                    body: clearAllConfirmMessage,\n                }).then((modal) => {\n                    modal.setSaveButtonText(yesString);\n                    modal.getRoot().on(ModalEvents.save, () => {\n                        // Save the current editor's default height before clearing.\n                        const target = editor.getElement();\n                        const storedDefaultheight = localStorage.getItem(`tiny_persistentresize_height_${target.id}_default`);\n\n                        // Clear all localStorage items related to this plugin.\n                        const keysToRemove = [];\n                        for (let i = 0; i < localStorage.length; i++) {\n                            const key = localStorage.key(i);\n                            if (key && key.startsWith('tiny_persistentresize_height_')) {\n                                keysToRemove.push(key);\n                            }\n                        }\n                        keysToRemove.forEach(key => localStorage.removeItem(key));\n\n                        // Reset the current editor to default height.\n                        if (storedDefaultheight) {\n                            editor.editorContainer.style.height = storedDefaultheight;\n                        }\n\n                        // Notify the user.\n                        Notification.alert(clearAllSuccessTitle, clearAllSuccessMessage);\n                    });\n                    modal.show();\n                    return modal;\n                }).catch(Notification.exception);\n            },\n        });\n\n        // Restore the editor height from localStorage if it exists.\n        editor.on('init', () => {\n            const target = editor.getElement();\n\n            // Store the default height in case the user wants to reset it later.\n            localStorage.setItem(`tiny_persistentresize_height_${target.id}_default`, editor.editorContainer.style.height);\n\n            const storedheight = localStorage.getItem(`tiny_persistentresize_height_${target.id}`);\n            if (storedheight) {\n                editor.editorContainer.style.height = storedheight;\n            }\n        });\n\n        // Store the editor height in localStorage whenever it is resized.\n        editor.on('ResizeEditor', function() {\n            const target = editor.getElement();\n            localStorage.setItem(`tiny_persistentresize_height_${target.id}`, editor.editorContainer.style.height);\n        });\n    };\n};\n"],"names":["async","menuTitle","menuImage","menuClearAllImage","confirmationTitle","confirmationMessage","clearAllMenuTitle","clearAllConfirmTitle","clearAllConfirmMessage","clearAllSuccessTitle","clearAllSuccessMessage","yesString","Promise","all","component","editor","ui","registry","addIcon","icon","html","iconclearall","addMenuItem","buttonName","text","onAction","target","getElement","storedDefaultheight","localStorage","getItem","id","editorContainer","style","height","removeItem","alert","clearAllButtonName","create","type","ModalFactory","types","SAVE_CANCEL","title","body","then","modal","setSaveButtonText","getRoot","on","ModalEvents","save","keysToRemove","i","length","key","startsWith","push","forEach","show","catch","Notification","exception","setItem","storedheight"],"mappings":";;;;;;;sQA8BwBA,gBAEhBC,UACAC,UACAC,kBACAC,kBACAC,oBACAC,kBACAC,qBACAC,uBACAC,qBACAC,uBACAC,iBACMC,QAAQC,IAAI,EAClB,mBAAU,YAAaC,oBACvB,yBAAe,WAAYA,oBAC3B,yBAAe,mBAAoBA,oBACnC,mBAAU,oBAAqBA,oBAC/B,mBAAU,sBAAuBA,oBACjC,mBAAU,oBAAqBA,oBAC/B,mBAAU,uBAAwBA,oBAClC,mBAAU,yBAA0BA,oBACpC,mBAAU,uBAAwBA,oBAClC,mBAAU,yBAA0BA,oBACpC,mBAAU,MAAO,iBAGbC,SAEJA,OAAOC,GAAGC,SAASC,QAAQC,aAAMjB,UAAUkB,MAC3CL,OAAOC,GAAGC,SAASC,QAAQG,qBAAclB,kBAAkBiB,MAG3DL,OAAOC,GAAGC,SAASK,YAAYC,mBAAY,CACvCJ,KAAAA,aACAK,KAAMvB,UACNwB,SAAU,WACAC,OAASX,OAAOY,aAChBC,oBAAsBC,aAAaC,+CAAwCJ,OAAOK,gBAIxFhB,OAAOiB,gBAAgBC,MAAMC,OAASN,oBACtCC,aAAaM,kDAA2CT,OAAOK,KAC/DF,aAAaM,kDAA2CT,OAAOK,sCAElDK,MAAMhC,kBAAmBC,wBAK9CU,OAAOC,GAAGC,SAASK,YAAYe,2BAAoB,CAC/ClB,KAAME,qBACNG,KAAMlB,kBACNmB,SAAU,4BAEOa,OAAO,CAChBC,KAAMC,uBAAaC,MAAMC,YACzBC,MAAOpC,qBACPqC,KAAMpC,yBACPqC,MAAMC,QACLA,MAAMC,kBAAkBpC,WACxBmC,MAAME,UAAUC,GAAGC,sBAAYC,MAAM,WAE3BzB,OAASX,OAAOY,aAChBC,oBAAsBC,aAAaC,+CAAwCJ,OAAOK,gBAGlFqB,aAAe,OAChB,IAAIC,EAAI,EAAGA,EAAIxB,aAAayB,OAAQD,IAAK,OACpCE,IAAM1B,aAAa0B,IAAIF,GACzBE,KAAOA,IAAIC,WAAW,kCACtBJ,aAAaK,KAAKF,KAG1BH,aAAaM,SAAQH,KAAO1B,aAAaM,WAAWoB,OAGhD3B,sBACAb,OAAOiB,gBAAgBC,MAAMC,OAASN,2CAI7BQ,MAAM3B,qBAAsBC,2BAE7CoC,MAAMa,OACCb,SACRc,MAAMC,sBAAaC,cAK9B/C,OAAOkC,GAAG,QAAQ,WACRvB,OAASX,OAAOY,aAGtBE,aAAakC,+CAAwCrC,OAAOK,eAAchB,OAAOiB,gBAAgBC,MAAMC,cAEjG8B,aAAenC,aAAaC,+CAAwCJ,OAAOK,KAC7EiC,eACAjD,OAAOiB,gBAAgBC,MAAMC,OAAS8B,iBAK9CjD,OAAOkC,GAAG,gBAAgB,iBAChBvB,OAASX,OAAOY,aACtBE,aAAakC,+CAAwCrC,OAAOK,IAAMhB,OAAOiB,gBAAgBC,MAAMC"}