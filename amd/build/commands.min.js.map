{"version":3,"file":"commands.min.js","sources":["../src/commands.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny persistentresize commands\n *\n * @module     tiny_persistentresize/commands\n * @copyright  2025 Andrew Rowatt <A.J.Rowatt@massey.ac.nz>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {getButtonImage} from 'editor_tiny/utils';\nimport {get_string as getString} from 'core/str';\nimport {component, buttonName, clearAllButtonName, icon} from 'tiny_persistentresize/common';\nimport Notification from 'core/notification';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\n\nexport const getSetup = async() => {\n    const [\n        menuTitle,\n        menuImage,\n        confirmationTitle,\n        confirmationMessage,\n        clearAllMenuTitle,\n        clearAllConfirmTitle,\n        clearAllConfirmMessage,\n        clearAllSuccessTitle,\n        clearAllSuccessMessage,\n    ] = await Promise.all([\n        getString('menutitle', component),\n        getButtonImage('menuicon', component),\n        getString('confirmationtitle', component),\n        getString('confirmationmessage', component),\n        getString('clearallmenutitle', component),\n        getString('clearallconfirmtitle', component),\n        getString('clearallconfirmmessage', component),\n        getString('clearallsuccesstitle', component),\n        getString('clearallsuccessmessage', component),\n    ]);\n\n    return (editor) => {\n        // Register the persistentresize icon.\n        editor.ui.registry.addIcon(icon, menuImage.html);\n\n        // Register the Menu item.\n        editor.ui.registry.addMenuItem(buttonName, {\n            icon,\n            text: menuTitle,\n            onAction: () => {\n                const target = editor.getElement();\n                const storedDefaultheight = localStorage.getItem(`tiny_persistentresize_height_${target.id}_default`);\n\n                // Reset to default height and remove stored height preference.\n                // Tiny will handle the actual resize and a null height with a sensible default.\n                editor.editorContainer.style.height = storedDefaultheight;\n                localStorage.removeItem(`tiny_persistentresize_height_${target.id}`);\n                localStorage.removeItem(`tiny_persistentresize_height_${target.id}_default`);\n                // Notify the user.\n                Notification.alert(confirmationTitle, confirmationMessage);\n            },\n        });\n\n        // Register the \"Clear All\" Menu item.\n        editor.ui.registry.addMenuItem(clearAllButtonName, {\n            icon,\n            text: clearAllMenuTitle,\n            onAction: () => {\n                // Show confirmation dialog.\n                ModalFactory.create({\n                    type: ModalFactory.types.SAVE_CANCEL,\n                    title: clearAllConfirmTitle,\n                    body: clearAllConfirmMessage,\n                }).then((modal) => {\n                    modal.setSaveButtonText(getString('yes', 'core'));\n                    modal.getRoot().on(ModalEvents.save, () => {\n                        // Clear all localStorage items related to this plugin.\n                        const keysToRemove = [];\n                        for (let i = 0; i < localStorage.length; i++) {\n                            const key = localStorage.key(i);\n                            if (key && key.startsWith('tiny_persistentresize_height_')) {\n                                keysToRemove.push(key);\n                            }\n                        }\n                        keysToRemove.forEach(key => localStorage.removeItem(key));\n\n                        // Reset the current editor to default height.\n                        const target = editor.getElement();\n                        const storedDefaultheight = localStorage.getItem(`tiny_persistentresize_height_${target.id}_default`);\n                        if (storedDefaultheight) {\n                            editor.editorContainer.style.height = storedDefaultheight;\n                        }\n\n                        // Notify the user.\n                        Notification.alert(clearAllSuccessTitle, clearAllSuccessMessage);\n                    });\n                    modal.show();\n                    return modal;\n                }).catch(Notification.exception);\n            },\n        });\n\n        // Restore the editor height from localStorage if it exists.\n        editor.on('init', () => {\n            const target = editor.getElement();\n\n            // Store the default height in case the user wants to reset it later.\n            localStorage.setItem(`tiny_persistentresize_height_${target.id}_default`, editor.editorContainer.style.height);\n\n            const storedheight = localStorage.getItem(`tiny_persistentresize_height_${target.id}`);\n            if (storedheight) {\n                editor.editorContainer.style.height = storedheight;\n            }\n        });\n\n        // Store the editor height in localStorage whenever it is resized.\n        editor.on('ResizeEditor', function() {\n            const target = editor.getElement();\n            localStorage.setItem(`tiny_persistentresize_height_${target.id}`, editor.editorContainer.style.height);\n        });\n    };\n};\n"],"names":["async","menuTitle","menuImage","confirmationTitle","confirmationMessage","clearAllMenuTitle","clearAllConfirmTitle","clearAllConfirmMessage","clearAllSuccessTitle","clearAllSuccessMessage","Promise","all","getString","component","getButtonImage","editor","ui","registry","addIcon","icon","html","addMenuItem","buttonName","text","onAction","target","getElement","storedDefaultheight","localStorage","getItem","id","editorContainer","style","height","removeItem","Notification","alert","clearAllButtonName","ModalFactory","create","type","types","SAVE_CANCEL","title","body","then","modal","setSaveButtonText","getRoot","on","ModalEvents","save","keysToRemove","i","length","key","startsWith","push","forEach","show","catch","exception","setItem","storedheight"],"mappings":";;WA8BwBA,UACpB,MACIC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,EACAC,SACMC,QAAQC,IAAI,CAClBC,EAAAA,WAAU,YAAaC,aACvBC,EAAAA,eAAe,WAAYD,aAC3BD,EAAAA,WAAU,oBAAqBC,aAC/BD,EAAAA,WAAU,sBAAuBC,aACjCD,EAAAA,WAAU,oBAAqBC,aAC/BD,EAAAA,WAAU,uBAAwBC,aAClCD,EAAAA,WAAU,yBAA0BC,aACpCD,EAAAA,WAAU,uBAAwBC,aAClCD,EAAAA,WAAU,yBAA0BC,eAGxC,OAAQE,IAEJA,EAAOC,GAAGC,SAASC,QAAQC,EAAAA,KAAMjB,EAAUkB,MAG3CL,EAAOC,GAAGC,SAASI,YAAYC,EAAAA,WAAY,CACnDH,KAAYA,EAAAA,KACAI,KAAMtB,EACNuB,SAAU,KACN,MAAMC,EAASV,EAAOW,aAChBC,EAAsBC,aAAaC,QAAQ,gCAAgCJ,EAAOK,cAIxFf,EAAOgB,gBAAgBC,MAAMC,OAASN,EACtCC,aAAaM,WAAW,gCAAgCT,EAAOK,MAC/DF,aAAaM,WAAW,gCAAgCT,EAAOK,cAE/DK,EAAaC,MAAMjC,EAAmBC,MAK9CW,EAAOC,GAAGC,SAASI,YAAYgB,EAAAA,mBAAoB,CAC3DlB,KAAYA,EAAAA,KACAI,KAAMlB,EACNmB,SAAU,KAENc,EAAaC,OAAO,CAChBC,KAAMF,EAAaG,MAAMC,YACzBC,MAAOrC,EACPsC,KAAMrC,IACPsC,KAAMC,IACLA,EAAMC,kBAAkBnC,EAAAA,WAAU,MAAO,SACzCkC,EAAME,UAAUC,GAAGC,EAAYC,KAAM,KAEjC,MAAMC,EAAe,GACrB,IAAK,IAAIC,EAAI,EAAGA,EAAIzB,aAAa0B,OAAQD,IAAK,CAC1C,MAAME,EAAM3B,aAAa2B,IAAIF,GACzBE,GAAOA,EAAIC,WAAW,kCACtBJ,EAAaK,KAAKF,EAE1B,CACAH,EAAaM,QAAQH,GAAO3B,aAAaM,WAAWqB,IAGpD,MAAM9B,EAASV,EAAOW,aAChBC,EAAsBC,aAAaC,QAAQ,gCAAgCJ,EAAOK,cACpFH,IACAZ,EAAOgB,gBAAgBC,MAAMC,OAASN,GAI1CQ,EAAaC,MAAM5B,EAAsBC,KAE7CqC,EAAMa,OACCb,IACRc,MAAMzB,EAAa0B,cAK9B9C,EAAOkC,GAAG,OAAQ,KACd,MAAMxB,EAASV,EAAOW,aAGtBE,aAAakC,QAAQ,gCAAgCrC,EAAOK,aAAcf,EAAOgB,gBAAgBC,MAAMC,QAEvG,MAAM8B,EAAenC,aAAaC,QAAQ,gCAAgCJ,EAAOK,MAC7EiC,IACAhD,EAAOgB,gBAAgBC,MAAMC,OAAS8B,KAK9ChD,EAAOkC,GAAG,eAAgB,WACtB,MAAMxB,EAASV,EAAOW,aACtBE,aAAakC,QAAQ,gCAAgCrC,EAAOK,KAAMf,EAAOgB,gBAAgBC,MAAMC,OACnG"}